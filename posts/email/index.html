<!DOCTYPE html> <html lang="en" class="single"> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>How to Add Needless Complexity to Your Life — garbage.world</title> <meta name="viewport" content="width=device-width, initial-scale=1"/> <meta name="description" content="The very good website of Alex Dunn"/> <meta name="keywords" content="cats, philosophy, twitter"/> <link href="/stylesheets/screen.css" rel="stylesheet" type="text/css" media="screen"/> <link href="/stylesheets/print.css" rel="stylesheet" type="text/css" media="print"/> <!--[if lt IE 9]><script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script><![endif]--> </head> <body> <p class="assistive-text"><a href="#content-start">Skip to main content</a></p> <header class="page-header"> <h1>How to Add Needless Complexity to Your Life</h1> </header> <main id="content-start"> <section class="posts"> <p>I used Apple Mail forever until recently, when my Exchange account starting causing it to blow itself up. Instead of installing Thunderbird and moving on with my life, I decided it was a good idea to start being a Serious Email User, and so I installed the Serious Email Client <a href="http://www.mutt.org">mutt</a>. But since this is a piece of Serious Software, there wasn&rsquo;t any easy-to-find, good documentation focused on actually <em>sending and receiving email</em> as opposed to Installing and Configuring mutt. (Even <a href="http://curvedthoughts.com/blog/email-using-getmail-msmtp-mutt/" title="Manage email using getmail, msmtp, and mutt">the hard-to-find ones</a> didn&rsquo;t go in-depth enough, and weren&rsquo;t written for OS X.) So this my attempt to get everything necessary—and nothing more—written down in one place.</p> <p></p> <h2 id="mutt-is-just-for-reading-email">mutt is just for reading email</h2> <p>The program mutt was not originally designed to do the actual sending and receiving of email. It can do that now, but it was built as a way to view local mail and to compose messages (except not really—you do the actual writing in your <code>$EDITOR</code>). Mail is fetched from a mail server using another program—I&rsquo;ll be using <a href="http://pyropus.ca/software/getmail/">getmail</a>. Mail is sent using yet another program—<a href="http://msmtp.sourceforge.net">msmtp</a>.</p> <p>And there&rsquo;s no point in having mutt if you&rsquo;ve got nothing to read, so before we even bother installing mutt we&rsquo;re going to set up getmail.</p> <h2 id="you-get-mail-with-getmail">you get mail with getmail</h2> <p>The easiest way to install getmail is with <a href="http://brew.sh" title="The missing package manager for OS X">Homebrew</a>:</p> <pre><code class="language-shell">brew install getmail
</code></pre> <p>The official <a href="http://pyropus.ca/software/getmail/configuration.html">configuration documentation</a> is not always very clear, but it is comprehensive. So we&rsquo;ll try to simplify it here, with some help from <a href="http://curvedthoughts.com/blog/email-using-getmail-msmtp-mutt/" title="Manage email using getmail, msmtp, and mutt">the blogosphere</a>.</p> <p>First set up the config directory, with restricted permissions for Serious Security:</p> <pre><code class="language-shell">mkdir -m 700 ~/.getmail
</code></pre> <p>In that folder you&rsquo;ll need to set up a config file for each email account you want to retrieve messages from. If you just have one, name the file <code>getmailrc</code>, which is what getmail looks for by default. The examples below are for setting up a Gmail account, so I named the below config file <code>gmailrc</code>:</p> <pre><code class="language-shell">[retriever]
type = SimpleIMAPSSLRetriever
server = imap.gmail.com
port = 993
mailboxes = ALL
username = gmail-address
ssl_version = tlsv1_2

[destination]
type = Maildir
path = ~/Mail/gmail/

[options]
message_log = ~/.getmail/gmail.log
read_all = false
</code></pre> <p>The most common alternative to <code>SimpleIMAPSSLRetriever</code> is probably <code>SimplePOP3SSLRetriever</code>, but there are <a href="http://pyropus.ca/software/getmail/configuration.html#conf-retriever">lots of types supported by getmail</a>.</p> <p>If you only want to download your inbox, don&rsquo;t specify <code>mailboxes</code>. If you want to download a subset of your mailboxes, replace <code>mailboxes = ALL</code> with a list of desired mailboxes in the following format:</p> <pre><code>mailboxes = (&quot;INBOX&quot;, &quot;INBOX.spam&quot;)
</code></pre> <p>getmail&rsquo;s <code>ssl_version</code> <a href="http://pyropus.ca/software/getmail/configuration.html#retriever-ssl-extra">defaults to SSLv23</a>, which needs to be overridden since it allows SSLv3, which is now <a href="http://poodlebleed.com">known to be vulnerable</a>.</p> <p>Replace <code>gmail-address</code> with your full Gmail email address, then create a Maildir directory structure in <code>~/Mail/gmail</code>:</p> <pre><code class="language-shell">mkdir -m 700 -p ~/Mail/gmail/{cur,new,tmp}
</code></pre> <p>(getmail supports <a href="http://qmail.org/qmail-manual-html/man5/mbox.html">mbox</a> in addition to Maildir; I don&rsquo;t really know the relative strengths and weaknesses but I went with Maildir ¯\_(ツ)_/¯.)</p> <p>The <code>[options]</code> are not required, but <code>read_all = false</code> is a very good idea (especially with <code>mailboxes = ALL</code>) because otherwise getmail will download all your mail every time you run it.</p> <p>You can specify <code>password</code> in your config file, but then it&rsquo;s sitting there in plain text and that&rsquo;s Bad. So instead, add the password to Keychain Access:</p> <pre><code class="language-shell">security add-internet-password -a 'gmail-address' -s 'imap.gmail.com' -r imap -P 993 -w app-specific-password
</code></pre> <p>Replace <code>gmail-address</code> again with your full Gmail email address, and <code>app-specific-password</code> with a <a href="https://support.google.com/accounts/answer/185833" title="Google Support">Google App Password</a>.</p> <p><strong>Important:</strong> if your password has characters like <code>$</code> that shells treat specially, make sure to put single quotes around the whole password.</p> <p>Then run getmail, with the <code>--rcfile</code> flag if you have config files that aren&rsquo;t named <code>getmailrc</code> (you can use the flag multiple times):</p> <pre><code class="language-shell">getmail --rcfile=gmailrc --rcfile=otheraccount
</code></pre> <p>Add that command to your <a href="https://help.ubuntu.com/community/CronHowto">cron jobs</a> or use <a href="http://nathangrigg.net/2012/07/schedule-jobs-using-launchd/">Apple&rsquo;s <code>launchd</code></a> to run it regularly.</p> <h2 id="then-you-install-mutt"><em>then</em> you install mutt</h2> <pre><code class="language-shell">brew install mutt --with-gpgme --with-confirm-attachment-patch
</code></pre> <p>The <code>--with-gpgme</code> flag enables <a href="https://www.gnupg.org/related_software/gpgme/">GPGME (GnuPG Made Easy)</a>, which is apparently <a href="http://henrytodd.org/notes/2014/simpler-gnupg-mutt-config-with-gpgme/">the right way to do encryption with mutt</a>. The <code>--with-confirm-attachment-patch</code> flag causes mutt to warn you before sending a message with &ldquo;attach&rdquo; in the body but no attachment. Both of these flags are optional, and there are other flags you might want to add; see <code>brew info mutt</code>.</p> <p>The only setting you <em>have</em> to add to your mutt configuration file (by default, <code>~/.muttrc</code>) is <code>set mbox_type=Maildir</code> (or <code>set mbox_type=mbox</code> as the case may be). You&rsquo;ll probably want to specify the location of your Gmail folder, though:</p> <pre><code>set mbox_type=Maildir
set folder = &quot;~/Mail/gmail/&quot;
set spoolfile = &quot;~/Mail/gmail/&quot;
set record = &quot;~/Mail/gmail/sent/&quot;
</code></pre> <p>The <code>sent</code> folder is technically another Maildir box, so you&rsquo;ll need to populate it with the same three folders:</p> <pre><code class="language-shell">mkdir -m 700 -p ~/Mail/gmail/sent/{cur,new,tmp}
</code></pre> <p>Fine-tuning your configuration and getting comfortable with the program isn&rsquo;t what this post is about; take a look at <a href="http://curvedthoughts.com/blog/email-using-getmail-msmtp-mutt/" title="Manage email using getmail, msmtp, and mutt">sample <code>.muttrc</code> files</a>, Steve Losh&rsquo;s <a href="http://stevelosh.com/blog/2012/10/the-homely-mutt/" title="The Homely Mutt">excellent guide</a> and the list of <a href="http://www.mutt.org/doc/manual/manual-6.html#functions">mutt commands</a>.</p> <p>I will mention one customization that I had to come up with for reading HTML emails on OS X. It&rsquo;s easy enough to <a href="http://www.debian-administration.org/article/75/Reading_HTML_email_with_Mutt" title="Debian Administration: Reading HTML email with Mutt">pass HTML emails and HTML attachments to a text-based browser</a> like lynx or w3m, but when I get <a href="http://tinyletter.com/todayintabs">Today in Tabs</a> I want to be able to <em>open the tabs</em> in Safari or whatever real browser I usually use. You can <a href="http://superuser.com/questions/422692/open-current-page-in-w3m-in-firefox">pass links from w3m to Firefox</a> if you&rsquo;re using Linux, but on OS X you&rsquo;d have to be using w3m from within emacs to be able to do that. <a href="http://hints.macworld.com/article.php?story=20051122200920326">Piping the HTML directly to Safari</a> doesn&rsquo;t work either, because the temporary file that mutt creates has the <code>.txt</code> extension, so Safari doesn&rsquo;t render the HTML. My solution is to add this to your <code>.muttrc</code>:</p> <pre><code>macro pager \cb &lt;pipe-entry&gt;'cat &gt; /tmp/mutt_mail.html; open /tmp/mutt_mail.html'&lt;enter&gt; 'open email in default browser'
</code></pre> <p>When you hit <code>^b</code> (control-b) while viewing an HTML message or attachment, what that does is spit the HTML into a temporary file, then open it in your default browser.</p> <p>(I wouldn&rsquo;t have figured this out if not for <a href="http://mutt.blackfish.org.uk/following-links/" title="my first mutt">Bruno Postle&rsquo;s page on following links</a>.)</p> <h2 id="and-send-mail-with-msmtp">and send mail with msmtp</h2> <p>By now you know the drill:</p> <pre><code class="language-shell">brew install msmtp
</code></pre> <p>Then set up your <a href="http://msmtp.sourceforge.net/doc/msmtp.html#Configuration-files">configuration file</a>, with permissions set to <code>600</code>, at <code>~/.msmtprc</code>:</p> <pre><code>defaults
tls on
tls_starttls on
tls_trust_file [see below]
logfile ~/Mail/msmtp.log

account gmail-address
host smtp.gmail.com
port 587
protocol smtp
auth on
from gmail-address
user gmail-address
</code></pre> <p>OS X doesn&rsquo;t have the <code>/etc/ssl/certs/ca-certificates.crt</code> file that some Linux systems do. All our certificates are in the Keychain Access application; so we need to export them:</p> <ol> <li><p>Open Keychain Access (<code>open -a /Applications/Utilities/Keychain\ Access.app/</code>).</p></li> <li><p>From the &ldquo;Keychains&rdquo; column, select &ldquo;System Roots.&rdquo;</p></li> <li><p>Select All, then go to File → Export Items&hellip; (<code>⇧⌘E</code>).</p></li> <li><p>Save the <code>.pem</code> file wherever, then set <code>tls_trust_file</code> to the path to it (for example, <code>~/Mail/certs/Certificates.pem</code>).</p></li> </ol> <p>Then return to your <code>.muttrc</code> and add: <code>set sendmail = &quot;/usr/local/bin/msmtp&quot;</code></p> <p>Add another Keychain entry:</p> <pre><code class="language-shell">security add-internet-password -a 'gmail-address' -s 'smtp.gmail.com' -r smtp -P 587 -w app-specific-password
</code></pre> <p>Again, replace <code>gmail-address</code> with your full Gmail email address, and <code>app-specific-password</code> with a <a href="https://support.google.com/accounts/answer/185833" title="Google Support">Google App Password</a>.</p> <h2 id="yay">yay</h2> <p>At this point you should be able to send and receive email using mutt! Wooooww. Now you can dick around with further niceties:</p> <ul> <li><p>Encrypt your emails. If you already have GPG installed, <a href="http://henrytodd.org/notes/2014/simpler-gnupg-mutt-config-with-gpgme/">following these instructions</a> will probably work. Otherwise <code>brew install gnupg gpg-agent</code> and <a href="https://wiki.archlinux.org/index.php/Gnupg">get them set up</a>.</p> <p>(If you start mutt and get the error message <em>&ldquo;Using GPGME backend, although no gpg-agent is running,&rdquo;</em> gpg-agent may be <a href="http://lists.gnupg.org/pipermail/gnupg-users/2007-May/031024.html">running in a different shell session</a>—this might occur if you&rsquo;re using a terminal multiplexer like screen or tmux, or if you&rsquo;re using the <a href="https://gpgtools.org">GPGTools</a>-supplied gpg-agent.)</p></li> <li><p><code>brew install lbdb</code> and create <code>~/.lbdbrc</code> with the following lines to link Contacts.app to mutt:</p> <pre><code>METHODS=&quot;m_muttalias m_osx_addressbook&quot;
MUTT_DIRECTORY=&quot;$HOME/.mutt&quot;
MUTTALIAS_FILES=&quot;.muttrc .mail_aliases muttrc aliases&quot;
</code></pre> <p>Then add <code>set query_command=&quot;/usr/local/bin/lbdbq '%s'&quot;</code> to your <code>.muttrc</code>, and use <code>^t</code> (control-t) to auto-complete addresses. (This is adapted from <a href="http://hints.macworld.com/article.php?story=20041024163030501">bluehz&rsquo;s instructions</a>.)</p></li> <li><p><a href="http://www.emacswiki.org/emacs/MuttInEmacs">Set up emacs as your message editor</a></p></li> </ul> <p>Contact me (<a href="http://pgp.mit.edu/pks/lookup?op=get&amp;search=0xFCEC4680ECF924D9">here&rsquo;s my public key!</a>) with feedback. Or yell at me <a href="https://twitter.com/dunndunndunn">on Twitter</a>.</p> </section> <footer class="sub-footer"> <p>Posted on <time datetime="2014-10-30 00:00:00 &#43;0000 UTC">30 October 2014</time>.<a class="reverse" title="Main page" href="/">Go to the main page</a> or see <a class="reverse" href="/posts">all posts</a>.</p> </footer> </main> <footer class="page-footer"> <p>Content copyright © 2015 <a href="https://twitter.com/dunndunndunn" title="@dunndunndunn">Alex Dunn</a></p> </footer> </body> </html>